{% extends 'base.html' %}
{% block title %}–ê–¥–º–∏–Ω–∫–∞ ‚Äî –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è{% endblock %}
{% block body %}
<header class="topbar">
  <div class="brand">
    <div class="logo-circle">A</div>
    <div class="org">
      <div class="org-title">–ê–¥–º–∏–Ω</div>
      <div class="org-sub">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∏–æ—Å–∫–æ–º</div>
    </div>
  </div>
  <div class="spacer"></div>
 <!--<button id="themeToggle" class="icon-btn" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô/‚òÄÔ∏è</button>-->
  <a class="btn btn-secondary" href="{{ url_for('logout') }}">–í—ã—Ö–æ–¥</a>
</header>

<main class="admin-main grid-2">

  <!-- –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è -->
<section class="card">
  <h3>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</h3>
  <form id="orgForm" class="form" action="{{ url_for('admin_organization_update') }}" method="post" enctype="multipart/form-data">
    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
  <input type="text" name="org_name" value="{{ organization.name if organization else '' }}" required>
</label>

<label>–õ–æ–≥–æ—Ç–∏–ø</label>
<div class="custom-file">
  <input type="file" name="org_logo" id="orgLogoFile" class="file-input" accept=".png,.jpg,.jpeg,.gif,.svg">
  <button type="button" class="btn btn-primary" onclick="document.getElementById('orgLogoFile').click();">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</button>
</div>
<br>
<img id="orgLogoPreview" src="{% if organization and organization.logo_path %}{{ url_for('uploads', filename=organization.logo_path) }}{% endif %}" alt="–ü—Ä–µ–≤—å—é –ª–æ–≥–æ—Ç–∏–ø–∞" style="width:100px; height:100px; object-fit:cover; border-radius:50%; margin-top:10px;">


    <br>
    <button class="btn btn-success" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</button>
  </form>
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const orgLogoInput = document.getElementById('orgLogoFile');
  const orgLogoPreview = document.getElementById('orgLogoPreview');

  orgLogoInput.addEventListener('change', () => {
    const file = orgLogoInput.files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = e => { orgLogoPreview.src = e.target.result; };
      reader.readAsDataURL(file);
    } else {
      orgLogoPreview.src = '';
    }
  });
});

</script>


  <!-- –ö–Ω–æ–ø–∫–∏ -->
  <section class="card">
    <h3>–ö–Ω–æ–ø–∫–∏</h3>
    <form id="buttonForm" class="form" action="{{ url_for('admin_button_create') }}" method="post" enctype="multipart/form-data">
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ<input name="title" required></label>
      <label>–¶–≤–µ—Ç –∫–Ω–æ–ø–∫–∏<input name="color" type="color" value="#0d6efd"></label>
      <label>–°—Ç—Ä–∞–Ω–∏—Ü–∞ 
        <select name="page_id" required>
          {% for p in pages %}
          <option value="{{ p['id'] }}">{{ p['title'] }}</option>
          {% endfor %}
        </select>
      </label>

      <!-- –°—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π input type=file -->
      <label>–ò–∫–æ–Ω–∫–∞</label>
      <div class="custom-file">
        <input type="file" name="icon" id="iconFile" class="file-input" accept=".png,.jpg,.jpeg,.gif,.svg">
        <button type="button" class="btn btn-primary" onclick="document.getElementById('iconFile').click();">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</button>
        <span class="file-name" id="iconFileName">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
      </div>
      <br>

      <button class="btn btn-primary" type="submit">–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É</button>
    </form>

    <div class="reorder-help">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏. –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å.</div>
    <ul id="buttonsList" class="list">
      {% for b in buttons %}
      <li class="list-item" draggable="true" data-id="{{ b['id'] }}" data-title="{{ b['title'] }}" data-color="{{ b['color'] or '#0d6efd' }}" data-page-id="{{ b['page_id'] }}">
        <span class="badge" style="background: {{ b['color'] or '#0d6efd' }}"></span>
        <span class="item-title">{{ b['title'] }}</span>
        <div class="right">
          <form class="inline" action="{{ url_for('admin_button_delete', bid=b['id']) }}" method="post" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–Ω–æ–ø–∫—É?')">
            <button class="btn btn-danger" type="submit">–£–¥–∞–ª–∏—Ç—å</button>
          </form>
        </div>
      </li>
      {% endfor %}
    </ul>
  </section>

  <!-- –°—Ç—Ä–∞–Ω–∏—Ü—ã -->
  <section class="card">
    <h3>–°—Ç—Ä–∞–Ω–∏—Ü—ã</h3>
    <form class="form" action="{{ url_for('admin_page_create') }}" method="post" enctype="multipart/form-data">
      <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫<input name="title" required></label>
      <label>–ö–æ–Ω—Ç–µ–Ω—Ç</label>
      <textarea id="content" name="content">{{ page['content'] if page else '' }}</textarea>

      <!-- PDF –±–ª–æ–∫ -->
      <label>PDF</label>
      <div id="pdfContainer">
        {% if pdfs %}
          {% for pdf in pdfs %}
          <div class="pdfItem">
            <input type="text" name="pdf_titles[]" value="{{ pdf['title'] }}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ PDF" required>
            <div class="custom-file">
              <input type="file" name="pdfs[]" class="file-input" accept=".pdf">
              <button type="button" class="btn btn-primary" onclick="this.previousElementSibling.click();">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</button>
              <span class="file-name">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
            </div>
            <button type="button" class="btn btn-danger removePdfBtn">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
          {% endfor %}
        {% else %}
          <div class="pdfItem">
            <input type="text" name="pdf_titles[]" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ PDF" required>
            <div class="custom-file">
              <input type="file" name="pdfs[]" class="file-input" accept=".pdf" required>
              <button type="button" class="btn btn-primary" onclick="this.previousElementSibling.click();">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</button>
              <span class="file-name">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
            </div>
            <button type="button" class="btn btn-danger removePdfBtn">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        {% endif %}
      </div>
      <button type="button" id="addPdfBtn" class="btn btn-secondary">–î–æ–±–∞–≤–∏—Ç—å –µ—â—ë PDF</button>

      <button class="btn btn-primary" type="submit">–°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
    </form>

    <ul class="list">
  {% for p in pages %}
  <li class="list-item">
    <strong>{{ p['title'] }}</strong>
    <div class="right">
      <a class="btn btn-secondary" href="{{ url_for('page', pid=p['id']) }}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å</a>
      <a class="btn btn-primary" href="{{ url_for('admin_page_edit', pid=p['id']) }}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
      <form class="inline" action="{{ url_for('admin_page_delete', pid=p['id']) }}" method="post" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?')">
        <button class="btn btn-danger" type="submit">–£–¥–∞–ª–∏—Ç—å</button>
      </form>
    </div>
  </li>
  {% endfor %}
</ul>

  </section>

</main>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏ -->
<div id="editModal" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:#fff; padding:20px; border:1px solid #ccc; z-index:1000;">
  <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏</h3>
  <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
  <input type="text" id="editTitle"><br><br>
  <label>–¶–≤–µ—Ç:</label>
  <input type="color" id="editColor"><br><br>
  <label>–°—Ç—Ä–∞–Ω–∏—Ü–∞:</label>
  <select id="editPage">
    {% for p in pages %}
      <option value="{{ p['id'] }}">{{ p['title'] }}</option>
    {% endfor %}
  </select><br><br>
  <button id="saveEdit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button type="button" onclick="closeEditModal()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
</div>

<!-- CKEditor 5 Classic Build —Ä–µ–¥–∞–∫—Ç–æ—Ä-->
<script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>


<script>
document.addEventListener('DOMContentLoaded', () => {

    // TinyMCE init
    ClassicEditor
        .create(document.querySelector('#content'), {
            toolbar: [
                'heading', '|', 'bold', 'italic', 'underline', 'strikethrough', '|',
                'link', 'bulletedList', 'numberedList', 'blockQuote', '|',
                'insertTable', 'imageUpload', '|',
                'undo', 'redo'
            ],
            simpleUpload: {
                // URL –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                uploadUrl: '/admin/upload_image'
            }
        })
        .catch(error => {
            console.error(error);
        });
});

    // Add/Remove PDF
    const addPdfBtn = document.getElementById('addPdfBtn');
    const pdfContainer = document.getElementById('pdfContainer');

    addPdfBtn.addEventListener('click', () => {
        const div = document.createElement('div');
        div.className = 'pdfItem';
        div.innerHTML = `
            <input type="text" name="pdf_titles[]" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ PDF" required>
            <div class="custom-file">
              <input type="file" name="pdfs[]" class="file-input" accept=".pdf" required>
              <button type="button" class="btn btn-primary" onclick="this.previousElementSibling.click();">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</button>
              <span class="file-name">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
            </div>
            <button type="button" class="btn btn-danger removePdfBtn">–£–¥–∞–ª–∏—Ç—å</button>
        `;
        pdfContainer.appendChild(div);

        div.querySelector('.removePdfBtn').addEventListener('click', () => div.remove());
        div.querySelector('.file-input').addEventListener('change', function(){
            const fileName = this.files[0] ? this.files[0].name : '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
            this.nextElementSibling.nextElementSibling.textContent = fileName;
        });
    });

    pdfContainer.querySelectorAll('.removePdfBtn').forEach(btn => {
        btn.addEventListener('click', e => e.target.closest('.pdfItem').remove());
    });

    pdfContainer.querySelectorAll('.file-input').forEach(input=>{
        input.addEventListener('change', function(){
            const fileName = this.files[0] ? this.files[0].name : '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
            this.nextElementSibling.nextElementSibling.textContent = fileName;
        });
    });

    // Edit Modal
    const editModal = document.getElementById('editModal');
    const editTitle = document.getElementById('editTitle');
    const editColor = document.getElementById('editColor');
    const editPage = document.getElementById('editPage');
    let editingId = null;

    window.openEditModal = (id, title, color, pageId) => {
        editingId = id;
        editTitle.value = title;
        editColor.value = color;
        editPage.value = pageId;
        editModal.style.display = 'block';
    };
    window.closeEditModal = () => { editModal.style.display='none'; editingId=null; };

    document.getElementById('saveEdit').addEventListener('click', async () => {
        if(!editingId) return;
        const form = new FormData();
        form.append('title', editTitle.value);
        form.append('color', editColor.value);
        form.append('page_id', editPage.value);

        await fetch(`/admin/button/update/${editingId}`, { method:'POST', body:form });
        location.reload();
    });

    // Buttons Drag & DoubleClick
    const list = document.getElementById('buttonsList');
    let dragEl = null;

    list.addEventListener('dblclick', e => {
        const item = e.target.closest('.list-item');
        if(!item) return;
        openEditModal(item.dataset.id, item.dataset.title, item.dataset.color, item.dataset.pageId);
    });

    list.addEventListener('dragstart', e => { dragEl = e.target.closest('.list-item'); });
    list.addEventListener('dragover', e => {
        e.preventDefault();
        const target = e.target.closest('.list-item');
        if (!target || target === dragEl) return;
        const rect = target.getBoundingClientRect();
        const next = (e.clientY - rect.top) > rect.height/2;
        list.insertBefore(dragEl, next ? target.nextSibling : target);
    });
    list.addEventListener('drop', async e => {
        e.preventDefault();
        const order = Array.from(list.querySelectorAll('.list-item')).map((li,i)=>({id:parseInt(li.dataset.id),position:i}));
        try {
            await fetch('/admin/button/reorder', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify(order)
            });
        } catch(err){ console.error(err); }
    });

});
</script>

<style>
body.dark-theme{background:#121212;color:#e0e0e0;}
body.dark-theme .topbar{background:#1f1f1f;}
body.dark-theme .card{background:#1e1e1e;color:#e0e0e0;}

.pdfItem { margin-bottom: 10px; display:flex; gap:5px; align-items:center; }
.pdfItem input[type="text"] { flex:2; }
.pdfItem .removePdfBtn { flex:1; }

.custom-file {
  display: flex;
  align-items: center;
  gap: 5px;
}

.file-input {
  display: none;
}

.file-name {
  font-size: 0.9em;
  color: #555;
}

.btn, .btn-primary, .btn-secondary, .btn-danger {
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.95em;
  transition: all 0.2s;
}

.btn:hover, .btn-primary:hover, .btn-secondary:hover, .btn-danger:hover {
  opacity: 0.9;
}

.btn-primary { background-color: #0d6efd; }
.btn-secondary { background-color: #6c757d; }
.btn-danger { background-color: #dc3545; }
</style>
{% endblock %}
