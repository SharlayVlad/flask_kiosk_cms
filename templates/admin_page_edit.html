{% extends 'base.html' %}
{% block title %}Редактирование страницы — {{ page['title'] }}{% endblock %}
{% block body %}
<header class="topbar">
  <div class="brand">
    <div class="logo-circle">A</div>
    <div class="org">
      <div class="org-title">Редактирование страницы</div>
      <div class="org-sub">{{ page['title'] }}</div>
    </div>
  </div>
  <div class="spacer"></div>
  <a class="btn btn-secondary" href="{{ url_for('admin') }}">Назад</a>
</header>

<main class="admin-main">
  <section class="card">
    <h3>Редактировать страницу</h3>

    <form class="form" id="adminForm" action="{{ url_for('admin_page_edit', pid=page['id']) }}" method="post" enctype="multipart/form-data">
      <label>Заголовок
        <input name="title" value="{{ page['title'] }}" required>
      </label>

      <label>Контент</label>
      <textarea id="content" name="content">{{ page['content'] or '' }}</textarea>

      <label>Загрузить PDF-файлы</label>
      <div id="pdfUploads">
        <!-- Первое поле -->
        <div class="pdf-upload">
          <input type="text" name="pdf_titles[]" placeholder="Название PDF" class="pdf-title-input">

          <label class="btn btn-primary custom-file-label">
            Выбрать файл
            <input type="file" name="pdfs[]" accept=".pdf" style="display:none">
          </label>

          <button type="button" class="btn btn-danger" onclick="removePdfField(this)">Удалить</button>
        </div>
      </div>
      <button type="button" class="btn btn-primary" id="addPdfBtn">Добавить PDF</button>

      {% if pdfs %}
        <div style="margin-top:10px;">
          <strong>Текущие PDF:</strong>
          <ul id="existingPdfs">
            {% for pdf in pdfs %}
              <li data-pdf-id="{{ pdf['id'] }}">
                {{ pdf['title'] }} —
                <a class="btn btn-secondary" href="{{ url_for('uploads', filename=pdf['file_path']) }}" target="_blank">Открыть</a>
                <button type="button" class="btn btn-danger delete-existing-pdf">Удалить</button>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% else %}
        <div style="margin-top:5px; color:#888;">PDF отсутствует</div>
      {% endif %}

      <button class="btn btn-success" type="submit">Сохранить</button>
    </form>
  </section>
</main>

<script src="{{ url_for('static', filename='tinymce/tinymce.min.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

   tinymce.init({
  selector: '#content',
  plugins: 'image table lists link code',
  toolbar: 'undo redo | styles | bold italic underline | alignleft aligncenter alignright | bullist numlist | table image link | code',
  height: 400,
  menubar: true,
  branding: false, // убирает "Powered by TinyMCE"
  images_upload_url: '/upload_image',
  automatic_uploads: true
});

  document.getElementById('addPdfBtn').addEventListener('click', addPdfField);

  document.querySelectorAll('.delete-existing-pdf').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const li = e.target.closest('li[data-pdf-id]');
      const pdfId = li.getAttribute('data-pdf-id');
      if (!confirm('Удалить этот PDF?')) return;

      try {
        const resp = await fetch(`{{ url_for('admin_page_pdf_delete', pdf_id=0) }}`.replace('/0', `/${pdfId}`), {
          method: 'POST'
        });
        const data = await resp.json();
        if (data && data.success) li.remove();
        else alert('Не удалось удалить PDF');
      } catch(err) {
        console.error(err);
        alert('Ошибка сети при удалении PDF');
      }
    });
  });

  document.getElementById('adminForm').addEventListener('submit', function(e) {
    const uploads = document.querySelectorAll('#pdfUploads .pdf-upload');
    for (let upload of uploads) {
      const title = upload.querySelector('input[name="pdf_titles[]"]').value.trim();
      const file = upload.querySelector('input[name="pdfs[]"]').value;
      if ((title && !file) || (!title && file)) {
        e.preventDefault();
        alert('Для загрузки PDF нужно указать и название, и выбрать файл!');
        return false;
      }
    }
    return true;
  });
});

function addPdfField() {
  const container = document.getElementById('pdfUploads');
  const div = document.createElement('div');
  div.classList.add('pdf-upload');

  const titleInput = document.createElement('input');
  titleInput.type = 'text';
  titleInput.name = 'pdf_titles[]';
  titleInput.placeholder = 'Название PDF';
  titleInput.classList.add('pdf-title-input');

  const label = document.createElement('label');
  label.classList.add('btn', 'btn-primary', 'custom-file-label');
  label.textContent = 'Выбрать файл';

  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.name = 'pdfs[]';
  fileInput.accept = '.pdf';
  fileInput.style.display = 'none';

  label.appendChild(fileInput);

  const removeBtn = document.createElement('button');
  removeBtn.type = 'button';
  removeBtn.classList.add('btn', 'btn-danger');
  removeBtn.textContent = 'Удалить';
  removeBtn.addEventListener('click', () => div.remove());

  div.appendChild(titleInput);
  div.appendChild(label);
  div.appendChild(removeBtn);

  container.appendChild(div);
}

function removePdfField(button) {
  button.parentElement.remove();
}
</script>

<style>
.pdf-upload { display:flex; gap:10px; margin-bottom:8px; align-items:center; }
.pdf-title-input { flex:2; }
.custom-file-label { flex:1; cursor:pointer; text-align:center; }
.pdf-upload input[type="file"] { display:none; }

.btn { display:inline-block; padding:6px 12px; font-size:14px; line-height:1.4; border-radius:8px; border:none; text-decoration:none; text-align:center; cursor:pointer; transition:background 0.2s; }
.btn-primary { background:#007bff; color:white; } .btn-primary:hover { background:#0069d9; }
.btn-secondary { background:#6c757d; color:white; } .btn-secondary:hover { background:#5a6268; }
.btn-danger { background:#dc3545; color:white; } .btn-danger:hover { background:#c82333; }
.btn-success { background:#28a745; color:white; } .btn-success:hover { background:#218838; }

#existingPdfs .btn.btn-secondary { padding:6px 12px; font-size:14px; }
</style>
{% endblock %}
